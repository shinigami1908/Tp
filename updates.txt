# defects: count and severity breakdown + escaped_to_prod sum
df = loaded.get("defects")
if df is not None:
    numeric = []
    if "escaped_to_prod" in df.columns:
        numeric.append("escaped_to_prod")
    per_table_period["defects"] = _safe_group_agg(
        df, ["employee_id", "period_half"],
        numeric_aggs=numeric,
        object_aggs=None,
        cat_expansions=["severity"] if "severity" in df.columns else None
    )

# jira_metrics
df = loaded.get("jira_metrics")
if df is not None:
    numeric_cols = [c for c in ["story_points_committed","story_points_completed","spillover_points","bugs_introduced","bugs_fixed"] if c in df.columns]
    per_table_period["jira"] = _safe_group_agg(df, ["employee_id", "period_half"], numeric_aggs=numeric_cols)

# github_metrics
df = loaded.get("github_metrics")
if df is not None:
    numeric_cols = [c for c in ["commits","pull_requests","reviews_done","copilot_suggestions_accepted","copilot_suggestions_total"] if c in df.columns]
    per_table_period["github"] = _safe_group_agg(df, ["employee_id", "period_half"], numeric_aggs=numeric_cols)
